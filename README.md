# GCS Bucket Policy Manager

This utility reads config files and applies bucket IAM policies for groups of service accounts and GCS buckets.


## Example Configuration

### groups.conf

Define groups of identities

```
[writeGroup]
serviceaccount1@myproject.iam.gserviceaccount.com

[readGroup]
serviceaccount2@myotherproject.iam.gserviceaccount.com
```

### roles.conf

Define alias for custom roles

```
readWrite myproject readWrite
readOnly myproject readOnly
```

### buckets.conf

Define groups of buckets

```
[mybuckets]
bucket1
bucket2
```

### policies.conf

Grant roles to groups

```
[mybuckets]
readWrite writeGroup
readOnly readGroup
```


## How it works

1. Reads config files and policy cache
2. Resolves bucket policies from configuration and compute hashes
3. Checks policy cache for each bucket
4. Updates bucket IAM policy if hash has changed
5. Writes updated policy cache


### Config Validation

It's possible to pass a list of allowed domains or projects and have the config parser enforce that all service accounts are associated with whitelisted projects and all users are associated with allowed domains.


### Policy Cache

The policy cache is a protobuf message defined in [policycache.proto](proto/policycache.proto) containing a timestamp and hash for each bucket.

Code was generated by running `protoc proto/policycache.proto --java_out=src/main/java`

The generated java class is [PolicyCache.java](src/main/java/com/google/cloud/util/bpm/PolicyCache.java)

The policy cache is saved by serializing to byte array and writing to a file.


### Policy Hash

The policy hash is generated by passing sorted role ids and identities through a SHA256 hash function.

If the hash of a generated policy matches the hash stored in the policy cache, no changes have been made and it is unnecessary to call the Storage API to update the policy.


## Pre-requisites

[SBT](https://www.scala-sbt.org/download.html)


## Building

`sbt assembly`


## Usage

```sh
java -Xmx1g -Xms1g -jar target/scala-2.11/bpm.jar
```


## Disclaimer

This is not an official Google project.
