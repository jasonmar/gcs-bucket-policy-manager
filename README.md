# GCS Bucket Policy Manager

This utility reads config files and applies bucket IAM policies for groups of service accounts and GCS buckets.


## Example Configuration

Caution - it's possible to apply a policy that prevents further updates. Be careful to include at least one role with `storage.getIamPolicy` and `storage.setIamPolicy` in order retain the ability to update the IAM policy.


### groups.conf

Define groups of identities

```
[writers]
serviceaccount1@myproject.iam.gserviceaccount.com

[readers]
serviceaccount2@myotherproject.iam.gserviceaccount.com

[admins]
admin@example.com
```

### roles.conf

Define alias for custom roles

```
rw myproject gcs_rw
ro myproject gcs_ro
adm myproject gcs_adm
```

### buckets.conf

Define groups of buckets

```
[mybuckets]
bucket1
bucket2
```

### policies.conf

Grant roles to groups

```
[mybuckets]
rw writers
ro readers
adm admins
```


## Example IAM Roles

These roles would be defined in [IAM Roles Console](https://console.cloud.google.com/iam-admin/roles) by selecting "+ Create Role"

`gcs_rw` grants permissions to read and write objects.

```
storage.buckets.get
storage.buckets.list
storage.objects.create
storage.objects.delete
storage.objects.get
storage.objects.list
storage.objects.update
```

`gcs_ro` grants permissions to read objects

```
storage.buckets.get
storage.buckets.list
storage.objects.get
storage.objects.list
```

`gcs_adm` grants permissions to modify bucket IAM policy

```
storage.buckets.create
storage.buckets.delete
storage.buckets.get
storage.buckets.getIamPolicy
storage.buckets.list
storage.buckets.setIamPolicy
storage.buckets.update
```


## How it works

1. Reads config files and policy cache
2. Resolves bucket policies from configuration and compute hashes
3. Checks policy cache for each bucket
4. Updates bucket IAM policy if hash has changed
5. Writes updated policy cache


### Config Validation

It's possible to pass a list of allowed domains or projects and have the config parser enforce that all service accounts are associated with whitelisted projects and all users are associated with allowed domains.


### Policy Cache

The policy cache is a protobuf message defined in [policycache.proto](proto/policycache.proto) containing a timestamp and hash for each bucket.

Code was generated by running `protoc proto/policycache.proto --java_out=src/main/java`

The generated java class is [PolicyCache.java](src/main/java/com/google/cloud/util/bpm/PolicyCache.java)

The policy cache is saved by serializing to byte array and writing to a file.


### Policy Hash

The policy hash is generated by passing sorted role ids and identities through a SHA256 hash function.

If the hash of a generated policy matches the hash stored in the policy cache, no changes have been made and it is unnecessary to call the Storage API to update the policy.


## Pre-requisites

[SBT](https://www.scala-sbt.org/download.html)


## Building

`sbt assembly`


## Usage

```sh
java -Xmx1g -Xms1g -jar target/scala-2.11/bpm.jar
```

### With Service Account Keyfile

```sh
java -Xmx1g -Xms1g -jar target/scala-2.11/bpm.jar -k /path/to/keyfile.json
```

### Help Text

```sh
java -Xmx1g -Xms1g -jar target/scala-2.11/bpm.jar --help
```

Output:

```
bpm 0.1
Usage: bpm [options]

  -b, --buckets <file>   buckets is an optional file property
  -g, --groups <file>    groups is an optional file property
  -p, --policies <file>  policies is an optional file property
  -r, --roles <file>     roles is an optional file property
  -c, --cache <file>     cache is an optional file property
  -k, --keyFile <file>   keyFile is an optional file property
  -t, --ttl <value>      cache ttl in milliseconds
  -w, --wait <value>     wait time between requests in milliseconds
  -m, --merge <value>    merge with existing policy
  -e, --remove <value>   remove roles from existing policy during merge
  --help                 prints this usage text
running without arguments will load configuration from default location and overwrite any existing bucket IAM policies with the generated policies
```


## Disclaimer

This is not an official Google project.
